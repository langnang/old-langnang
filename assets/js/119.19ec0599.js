(window.webpackJsonp=window.webpackJsonp||[]).push([[119],{588:function(e,n,r){"use strict";r.r(n);var t=r(18),a=Object(t.a)({},(function(){var e=this,n=e.$createElement,r=e._self._c||n;return r("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[r("h1",{attrs:{id:"c-嵌入器-node-js-api-文档"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#c-嵌入器-node-js-api-文档"}},[e._v("#")]),e._v(" C++ 嵌入器 | Node.js API 文档")]),e._v(" "),r("blockquote",[r("h2",{attrs:{id:"excerpt"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#excerpt"}},[e._v("#")]),e._v(" Excerpt")]),e._v(" "),r("p",[e._v("中英对照")])]),e._v(" "),r("hr"),e._v(" "),r("ul",[r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/documentation.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("关于本文档"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/synopsis.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("用法与示例"),r("OutboundLink")],1)])]),e._v(" "),r("hr"),e._v(" "),r("ul",[r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/assert.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("assert断言"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/async_hooks.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("async_hooks异步钩子"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/buffer.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("buffer缓冲区"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/addons.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("C++插件"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/n-api.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("C/C++插件(使用Node-API)"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/embedding.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("C++嵌入器"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/child_process.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("child_process子进程"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/cluster.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("cluster集群"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/cli.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("CLI命令行"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/console.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("console控制台"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/crypto.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("crypto加密"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/debugger.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("debugger调试器"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/deprecations.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("deprecation弃用"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/dgram.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("dgram数据报"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/dns.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("dns域名服务器"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/domain.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("domain域"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/errors.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Error错误"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/events.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("events事件触发器"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/fs.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("fs文件系统"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/globals.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("global全局变量"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/http.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("http超文本传输协议"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/http2.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("http2超文本传输协议2.0"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/https.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("https安全超文本传输协议"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/inspector.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("inspector检查器"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/intl.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Intl国际化"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/module.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("module模块"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/modules.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("module/cjsCommonJS模块"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/esm.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("module/esmECMAScript模块"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/packages.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("module/package包模块"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/net.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("net网络"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/os.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("os操作系统"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/path.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("path路径"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/perf_hooks.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("perf_hooks性能钩子"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/policy.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("policy安全策略"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/process.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("process进程"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/punycode.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("punycode域名代码"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/querystring.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("querystring查询字符串"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/readline.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("readline逐行读取"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/repl.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("repl交互式解释器"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/report.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("report诊断报告"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/stream.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("stream流"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/string_decoder.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("string_decoder字符串解码器"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/timers.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("timers定时器"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/tls.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("tls安全传输层"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/tracing.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("trace_events跟踪事件"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/tty.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("tty终端"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/url.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("url网址"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/util.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("util实用工具"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/v8.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("v8引擎"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/vm.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("vm虚拟机"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/wasi.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("wasi网络汇编系统接口"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/worker_threads.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("worker_threads工作线程"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/zlib.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("zlib压缩"),r("OutboundLink")],1)])]),e._v(" "),r("p",[e._v("目录")]),e._v(" "),r("ul",[r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/embedding.html#c-embedder-api",target:"_blank",rel:"noopener noreferrer"}},[e._v("C++ 嵌入器"),r("OutboundLink")],1),e._v(" "),r("ul",[r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/embedding.html#example-embedding-application",target:"_blank",rel:"noopener noreferrer"}},[e._v("嵌入式应用程序的示例"),r("OutboundLink")],1),e._v(" "),r("ul",[r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/embedding.html#setting-up-per-process-state",target:"_blank",rel:"noopener noreferrer"}},[e._v("设置每个进程的状态"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/embedding.html#per-instance-state",target:"_blank",rel:"noopener noreferrer"}},[e._v("每个实例的状态"),r("OutboundLink")],1)])])])])])]),e._v(" "),r("p",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/embedding/c_embedder_api.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("中英对照"),r("OutboundLink")],1)]),e._v(" "),r("p",[e._v("Node.js 提供了许多 C++ API，可用于在 Node.js 环境中从其他 C++ 软件执行 JavaScript。")]),e._v(" "),r("p",[e._v("这些 API 的文档可以在 Node.js 源代码树的 "),r("a",{attrs:{href:"http://url.nodejs.cn/RrEfEU",target:"_blank",rel:"noopener noreferrer"}},[e._v("src/node.h"),r("OutboundLink")],1),e._v(" 中找到。 除了 Node.js 暴露的 API，V8 嵌入器 API 还提供了一些必需的概念。")]),e._v(" "),r("p",[e._v("因为使用 Node.js 作为嵌入式库与编写由 Node.js 执行的代码不同，破坏性更改不遵循典型的 Node.js "),r("a",{attrs:{href:"http://nodejs.cn/api-v12/deprecations.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("弃用策略"),r("OutboundLink")],1),e._v("，并且可能在每个语义化主版本上发生，而没有事先警告.")]),e._v(" "),r("h3",{attrs:{id:"嵌入式应用程序的示例"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#嵌入式应用程序的示例"}},[e._v("#")]),e._v(" 嵌入式应用程序的示例"),r("a",{attrs:{href:"http://nodejs.cn/api-v12/embedding.html#example-embedding-application",target:"_blank",rel:"noopener noreferrer"}},[e._v("#"),r("OutboundLink")],1)]),e._v(" "),r("p",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/embedding/example_embedding_application.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("中英对照"),r("OutboundLink")],1)]),e._v(" "),r("p",[e._v("以下章节将概述如何使用这些 API 从头开始创建应用程序，该应用程序将执行相当于 "),r("code",[e._v("node -e <code>")]),e._v(" 的操作，也就是将使用一段 JavaScript 并在特定于 Node.js 的环境中运行。")]),e._v(" "),r("p",[e._v("可以在 "),r("a",{attrs:{href:"http://url.nodejs.cn/zZQsng",target:"_blank",rel:"noopener noreferrer"}},[e._v("Node.js 源代码树"),r("OutboundLink")],1),e._v("中找到完整的代码。")]),e._v(" "),r("h4",{attrs:{id:"设置每个进程的状态"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#设置每个进程的状态"}},[e._v("#")]),e._v(" 设置每个进程的状态"),r("a",{attrs:{href:"http://nodejs.cn/api-v12/embedding.html#setting-up-per-process-state",target:"_blank",rel:"noopener noreferrer"}},[e._v("#"),r("OutboundLink")],1)]),e._v(" "),r("p",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/embedding/setting_up_per_process_state.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("中英对照"),r("OutboundLink")],1)]),e._v(" "),r("p",[e._v("Node.js 需要一些每个进程的状态管理才能运行：")]),e._v(" "),r("ul",[r("li",[e._v("为 Node.js "),r("a",{attrs:{href:"http://nodejs.cn/api-v12/cli.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("命令行选项"),r("OutboundLink")],1),e._v("解析的参数，")]),e._v(" "),r("li",[e._v("V8 每个进程要求，例如 "),r("code",[e._v("v8::Platform")]),e._v(" 实例。")])]),e._v(" "),r("p",[e._v("下面的示例展示了如何设置这些。 一些类名分别来自 "),r("code",[e._v("node")]),e._v(" 和 "),r("code",[e._v("v8")]),e._v(" C++ 命名空间。")]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('int main(int argc, char** argv) {\n  argv = uv_setup_args(argc, argv);\n  std::vector<std::string> args(argv, argv + argc);\n  std::vector<std::string> exec_args;\n  std::vector<std::string> errors;\n  // 解析 Node.js 命令行选项，\n  // 并打印尝试解析它们时发生的任何错误。\n  int exit_code = node::InitializeNodeWithArgs(&args, &exec_args, &errors);\n  for (const std::string& error : errors)\n    fprintf(stderr, "%s: %s\\n", args[0].c_str(), error.c_str());\n  if (exit_code != 0) {\n    return exit_code;\n  }\n\n  // 创建 v8::Platform 实例。\n  // `MultiIsolatePlatform::Create()` 是一种创建 v8::Platform 实例的方法，Node.js 在创建时可以使用它\n  // 工作线程。当没有 `MultiIsolatePlatform` 实例时，\n  // 工作线程被禁用。\n  std::unique_ptr<MultiIsolatePlatform> platform =\n      MultiIsolatePlatform::Create(4);\n  V8::InitializePlatform(platform.get());\n  V8::Initialize();\n\n  // 此函数的内容见下文。\n  int ret = RunNodeInstance(platform.get(), args, exec_args);\n\n  V8::Dispose();\n  V8::ShutdownPlatform();\n  return ret;\n}\n')])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br"),r("span",{staticClass:"line-number"},[e._v("2")]),r("br"),r("span",{staticClass:"line-number"},[e._v("3")]),r("br"),r("span",{staticClass:"line-number"},[e._v("4")]),r("br"),r("span",{staticClass:"line-number"},[e._v("5")]),r("br"),r("span",{staticClass:"line-number"},[e._v("6")]),r("br"),r("span",{staticClass:"line-number"},[e._v("7")]),r("br"),r("span",{staticClass:"line-number"},[e._v("8")]),r("br"),r("span",{staticClass:"line-number"},[e._v("9")]),r("br"),r("span",{staticClass:"line-number"},[e._v("10")]),r("br"),r("span",{staticClass:"line-number"},[e._v("11")]),r("br"),r("span",{staticClass:"line-number"},[e._v("12")]),r("br"),r("span",{staticClass:"line-number"},[e._v("13")]),r("br"),r("span",{staticClass:"line-number"},[e._v("14")]),r("br"),r("span",{staticClass:"line-number"},[e._v("15")]),r("br"),r("span",{staticClass:"line-number"},[e._v("16")]),r("br"),r("span",{staticClass:"line-number"},[e._v("17")]),r("br"),r("span",{staticClass:"line-number"},[e._v("18")]),r("br"),r("span",{staticClass:"line-number"},[e._v("19")]),r("br"),r("span",{staticClass:"line-number"},[e._v("20")]),r("br"),r("span",{staticClass:"line-number"},[e._v("21")]),r("br"),r("span",{staticClass:"line-number"},[e._v("22")]),r("br"),r("span",{staticClass:"line-number"},[e._v("23")]),r("br"),r("span",{staticClass:"line-number"},[e._v("24")]),r("br"),r("span",{staticClass:"line-number"},[e._v("25")]),r("br"),r("span",{staticClass:"line-number"},[e._v("26")]),r("br"),r("span",{staticClass:"line-number"},[e._v("27")]),r("br"),r("span",{staticClass:"line-number"},[e._v("28")]),r("br"),r("span",{staticClass:"line-number"},[e._v("29")]),r("br"),r("span",{staticClass:"line-number"},[e._v("30")]),r("br")])]),r("h4",{attrs:{id:"每个实例的状态"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#每个实例的状态"}},[e._v("#")]),e._v(" 每个实例的状态"),r("a",{attrs:{href:"http://nodejs.cn/api-v12/embedding.html#per-instance-state",target:"_blank",rel:"noopener noreferrer"}},[e._v("#"),r("OutboundLink")],1)]),e._v(" "),r("p",[r("a",{attrs:{href:"http://nodejs.cn/api-v12/embedding/per_instance_state.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("中英对照"),r("OutboundLink")],1)]),e._v(" "),r("p",[e._v("Node.js 有“Node.js 实例”的概念，通常被称为 "),r("code",[e._v("node::Environment")]),e._v("。 每个 "),r("code",[e._v("node::Environment")]),e._v(" 都与：")]),e._v(" "),r("ul",[r("li",[e._v("正好是 "),r("code",[e._v("v8::Isolate")]),e._v("，即 JS 引擎实例，")]),e._v(" "),r("li",[e._v("正好是 "),r("code",[e._v("uv_loop_t")]),e._v("，即事件循环，并且")]),e._v(" "),r("li",[e._v("许多 "),r("code",[e._v("v8::Context")]),e._v("，但只有一个主要的 "),r("code",[e._v("v8::Context")]),e._v("。")]),e._v(" "),r("li",[r("code",[e._v("node::IsolateData")]),e._v(" 实例包含的信息可以由使用相同 "),r("code",[e._v("v8::Isolate")]),e._v(" 的多个 "),r("code",[e._v("node::Environment")]),e._v(" 共享。 目前，没有针对此场景执行测试。")])]),e._v(" "),r("p",[e._v("为了设置 "),r("code",[e._v("v8::Isolate")]),e._v("，需要提供 "),r("code",[e._v("v8::ArrayBuffer::Allocator")]),e._v("。 一种可能的选择是默认的 Node.js 分配器，它可以通过 "),r("code",[e._v("node::ArrayBufferAllocator::Create()")]),e._v(" 创建。 当插件使用 Node.js C++ "),r("code",[e._v("Buffer")]),e._v(" API 时，使用 Node.js 分配器可以实现较小的性能优化，并且需要在 "),r("a",{attrs:{href:"http://nodejs.cn/api-v12/process.html#process_process_memoryusage",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("process.memoryUsage()")]),r("OutboundLink")],1),e._v(" 中跟踪 "),r("code",[e._v("ArrayBuffer")]),e._v(" 内存。")]),e._v(" "),r("p",[e._v("此外，每个用于 Node.js 实例的 "),r("code",[e._v("v8::Isolate")]),e._v(" 都需要在 "),r("code",[e._v("MultiIsolatePlatform")]),e._v(" 实例中注册和注销（如果正在使用），以便平台知道对于 "),r("code",[e._v("v8::Isolate")]),e._v(" 调度的任务使用哪个事件循环。")]),e._v(" "),r("p",[r("code",[e._v("node::NewIsolate()")]),e._v(" 辅助函数创建 "),r("code",[e._v("v8::Isolate")]),e._v("，使用一些 Node.js 特定的钩子（例如 Node.js 错误句柄）设置，并自动将其注册到平台。")]),e._v(" "),r("div",{staticClass:"language- line-numbers-mode"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('int RunNodeInstance(MultiIsolatePlatform* platform,\n                    const std::vector<std::string>& args,\n                    const std::vector<std::string>& exec_args) {\n  int exit_code = 0;\n  // 设置 libuv 事件循环。\n  uv_loop_t loop;\n  int ret = uv_loop_init(&loop);\n  if (ret != 0) {\n    fprintf(stderr, "%s: Failed to initialize loop: %s\\n",\n            args[0].c_str(),\n            uv_err_name(ret));\n    return 1;\n  }\n\n  std::shared_ptr<ArrayBufferAllocator> allocator =\n      ArrayBufferAllocator::Create();\n\n  Isolate* isolate = NewIsolate(allocator, &loop, platform);\n  if (isolate == nullptr) {\n    fprintf(stderr, "%s: Failed to initialize V8 Isolate\\n", args[0].c_str());\n    return 1;\n  }\n\n  {\n    Locker locker(isolate);\n    Isolate::Scope isolate_scope(isolate);\n\n    // 创建 node::IsolateData 实例，\n    // 稍后将使用 node::FreeIsolateData() 释放该实例。\n    std::unique_ptr<IsolateData, decltype(&node::FreeIsolateData)> isolate_data(\n        node::CreateIsolateData(isolate, &loop, platform, allocator.get()),\n        node::FreeIsolateData);\n\n    // 设置新的 v8::Context。\n    HandleScope handle_scope(isolate);\n    Local<Context> context = node::NewContext(isolate);\n    if (context.IsEmpty()) {\n      fprintf(stderr, "%s: Failed to initialize V8 Context\\n", args[0].c_str());\n      return 1;\n    }\n\n    // 当调用 node::CreateEnvironment() 和 node::LoadEnvironment() 时，\n    // 需要输入 v8::Context。\n    Context::Scope context_scope(context);\n\n    // 创建 node::Environment 实例，\n    // 稍后将使用 node::FreeEnvironment() 释放该实例。\n    std::unique_ptr<Environment, decltype(&node::FreeEnvironment)> env(\n        node::CreateEnvironment(isolate_data.get(), context, args, exec_args),\n        node::FreeEnvironment);\n\n    // 设置要执行的 Node.js 实例，并在其中运行代码。\n    // 还有一个变体接受回调\n    // 并为其提供 `require` 和 `process` 对象，\n    // 以便它可以根据需要手动编译和运行脚本。\n    // 此脚本中的 `require` 函数不访问文件系统，\n    // 并且只能加载 Node.js 内置模块。\n    // `module.createRequire()` 被用来创建能够从磁盘加载文件的文件，\n    // 并使用标准的 CommonJS 文件加载器\n    // 而不是内部的 `require` 函数。\n    MaybeLocal<Value> loadenv_ret = node::LoadEnvironment(\n        env.get(),\n        "const publicRequire ="\n        "  require(\'module\').createRequire(process.cwd() + \'/\');"\n        "globalThis.require = publicRequire;"\n        "require(\'vm\').runInThisContext(process.argv[1]);");\n\n    if (loadenv_ret.IsEmpty())  // 出现了 JS 异常。\n      return 1;\n\n    {\n      // SealHandleScope 防止来自回调的句柄泄漏。\n      SealHandleScope seal(isolate);\n      bool more;\n      do {\n        uv_run(&loop, UV_RUN_DEFAULT);\n\n        // 后台线程上的 V8 任务可能最终会在前台调度新任务，从而使事件循环继续进行。\n        // 例如，\n        // WebAssembly.compile() 可能会这样做。\n        platform->DrainTasks(isolate);\n\n        // 如果有新任务，则继续。\n        more = uv_loop_alive(&loop);\n        if (more) continue;\n\n        // \n        node::EmitBeforeExit(env.get());\n\n        // \'beforeExit\' 还可以调度新的新工作，\n        // 以使事件循环保持运行。\n        more = uv_loop_alive(&loop);\n      } while (more == true);\n    }\n\n    // \n    exit_code = node::EmitExit(env.get());\n\n    // node::Stop() 可用于显式停止事件循环并阻止进一步的 JavaScript 运行。\n    // 它可以从任何线程调用，\n    // 如果从另一个线程调用，则像 worker.terminate() 一样。\n    node::Stop(env.get());\n  }\n\n  // 取消向平台注册 Isolate 并添加监听器，\n  // 当平台完成清理它与 Isolate 关联的任何状态时，\n  // 则调用该监听器。\n  bool platform_finished = false;\n  platform->AddIsolateFinishedCallback(isolate, [](void* data) {\n    *static_cast<bool*>(data) = true;\n  }, &platform_finished);\n  platform->UnregisterIsolate(isolate);\n  isolate->Dispose();\n\n  // 等到平台清理完所有相关资源。\n  while (!platform_finished)\n    uv_run(&loop, UV_RUN_ONCE);\n  int err = uv_loop_close(&loop);\n  assert(err == 0);\n\n  return exit_code;\n}\n')])]),e._v(" "),r("div",{staticClass:"line-numbers-wrapper"},[r("span",{staticClass:"line-number"},[e._v("1")]),r("br"),r("span",{staticClass:"line-number"},[e._v("2")]),r("br"),r("span",{staticClass:"line-number"},[e._v("3")]),r("br"),r("span",{staticClass:"line-number"},[e._v("4")]),r("br"),r("span",{staticClass:"line-number"},[e._v("5")]),r("br"),r("span",{staticClass:"line-number"},[e._v("6")]),r("br"),r("span",{staticClass:"line-number"},[e._v("7")]),r("br"),r("span",{staticClass:"line-number"},[e._v("8")]),r("br"),r("span",{staticClass:"line-number"},[e._v("9")]),r("br"),r("span",{staticClass:"line-number"},[e._v("10")]),r("br"),r("span",{staticClass:"line-number"},[e._v("11")]),r("br"),r("span",{staticClass:"line-number"},[e._v("12")]),r("br"),r("span",{staticClass:"line-number"},[e._v("13")]),r("br"),r("span",{staticClass:"line-number"},[e._v("14")]),r("br"),r("span",{staticClass:"line-number"},[e._v("15")]),r("br"),r("span",{staticClass:"line-number"},[e._v("16")]),r("br"),r("span",{staticClass:"line-number"},[e._v("17")]),r("br"),r("span",{staticClass:"line-number"},[e._v("18")]),r("br"),r("span",{staticClass:"line-number"},[e._v("19")]),r("br"),r("span",{staticClass:"line-number"},[e._v("20")]),r("br"),r("span",{staticClass:"line-number"},[e._v("21")]),r("br"),r("span",{staticClass:"line-number"},[e._v("22")]),r("br"),r("span",{staticClass:"line-number"},[e._v("23")]),r("br"),r("span",{staticClass:"line-number"},[e._v("24")]),r("br"),r("span",{staticClass:"line-number"},[e._v("25")]),r("br"),r("span",{staticClass:"line-number"},[e._v("26")]),r("br"),r("span",{staticClass:"line-number"},[e._v("27")]),r("br"),r("span",{staticClass:"line-number"},[e._v("28")]),r("br"),r("span",{staticClass:"line-number"},[e._v("29")]),r("br"),r("span",{staticClass:"line-number"},[e._v("30")]),r("br"),r("span",{staticClass:"line-number"},[e._v("31")]),r("br"),r("span",{staticClass:"line-number"},[e._v("32")]),r("br"),r("span",{staticClass:"line-number"},[e._v("33")]),r("br"),r("span",{staticClass:"line-number"},[e._v("34")]),r("br"),r("span",{staticClass:"line-number"},[e._v("35")]),r("br"),r("span",{staticClass:"line-number"},[e._v("36")]),r("br"),r("span",{staticClass:"line-number"},[e._v("37")]),r("br"),r("span",{staticClass:"line-number"},[e._v("38")]),r("br"),r("span",{staticClass:"line-number"},[e._v("39")]),r("br"),r("span",{staticClass:"line-number"},[e._v("40")]),r("br"),r("span",{staticClass:"line-number"},[e._v("41")]),r("br"),r("span",{staticClass:"line-number"},[e._v("42")]),r("br"),r("span",{staticClass:"line-number"},[e._v("43")]),r("br"),r("span",{staticClass:"line-number"},[e._v("44")]),r("br"),r("span",{staticClass:"line-number"},[e._v("45")]),r("br"),r("span",{staticClass:"line-number"},[e._v("46")]),r("br"),r("span",{staticClass:"line-number"},[e._v("47")]),r("br"),r("span",{staticClass:"line-number"},[e._v("48")]),r("br"),r("span",{staticClass:"line-number"},[e._v("49")]),r("br"),r("span",{staticClass:"line-number"},[e._v("50")]),r("br"),r("span",{staticClass:"line-number"},[e._v("51")]),r("br"),r("span",{staticClass:"line-number"},[e._v("52")]),r("br"),r("span",{staticClass:"line-number"},[e._v("53")]),r("br"),r("span",{staticClass:"line-number"},[e._v("54")]),r("br"),r("span",{staticClass:"line-number"},[e._v("55")]),r("br"),r("span",{staticClass:"line-number"},[e._v("56")]),r("br"),r("span",{staticClass:"line-number"},[e._v("57")]),r("br"),r("span",{staticClass:"line-number"},[e._v("58")]),r("br"),r("span",{staticClass:"line-number"},[e._v("59")]),r("br"),r("span",{staticClass:"line-number"},[e._v("60")]),r("br"),r("span",{staticClass:"line-number"},[e._v("61")]),r("br"),r("span",{staticClass:"line-number"},[e._v("62")]),r("br"),r("span",{staticClass:"line-number"},[e._v("63")]),r("br"),r("span",{staticClass:"line-number"},[e._v("64")]),r("br"),r("span",{staticClass:"line-number"},[e._v("65")]),r("br"),r("span",{staticClass:"line-number"},[e._v("66")]),r("br"),r("span",{staticClass:"line-number"},[e._v("67")]),r("br"),r("span",{staticClass:"line-number"},[e._v("68")]),r("br"),r("span",{staticClass:"line-number"},[e._v("69")]),r("br"),r("span",{staticClass:"line-number"},[e._v("70")]),r("br"),r("span",{staticClass:"line-number"},[e._v("71")]),r("br"),r("span",{staticClass:"line-number"},[e._v("72")]),r("br"),r("span",{staticClass:"line-number"},[e._v("73")]),r("br"),r("span",{staticClass:"line-number"},[e._v("74")]),r("br"),r("span",{staticClass:"line-number"},[e._v("75")]),r("br"),r("span",{staticClass:"line-number"},[e._v("76")]),r("br"),r("span",{staticClass:"line-number"},[e._v("77")]),r("br"),r("span",{staticClass:"line-number"},[e._v("78")]),r("br"),r("span",{staticClass:"line-number"},[e._v("79")]),r("br"),r("span",{staticClass:"line-number"},[e._v("80")]),r("br"),r("span",{staticClass:"line-number"},[e._v("81")]),r("br"),r("span",{staticClass:"line-number"},[e._v("82")]),r("br"),r("span",{staticClass:"line-number"},[e._v("83")]),r("br"),r("span",{staticClass:"line-number"},[e._v("84")]),r("br"),r("span",{staticClass:"line-number"},[e._v("85")]),r("br"),r("span",{staticClass:"line-number"},[e._v("86")]),r("br"),r("span",{staticClass:"line-number"},[e._v("87")]),r("br"),r("span",{staticClass:"line-number"},[e._v("88")]),r("br"),r("span",{staticClass:"line-number"},[e._v("89")]),r("br"),r("span",{staticClass:"line-number"},[e._v("90")]),r("br"),r("span",{staticClass:"line-number"},[e._v("91")]),r("br"),r("span",{staticClass:"line-number"},[e._v("92")]),r("br"),r("span",{staticClass:"line-number"},[e._v("93")]),r("br"),r("span",{staticClass:"line-number"},[e._v("94")]),r("br"),r("span",{staticClass:"line-number"},[e._v("95")]),r("br"),r("span",{staticClass:"line-number"},[e._v("96")]),r("br"),r("span",{staticClass:"line-number"},[e._v("97")]),r("br"),r("span",{staticClass:"line-number"},[e._v("98")]),r("br"),r("span",{staticClass:"line-number"},[e._v("99")]),r("br"),r("span",{staticClass:"line-number"},[e._v("100")]),r("br"),r("span",{staticClass:"line-number"},[e._v("101")]),r("br"),r("span",{staticClass:"line-number"},[e._v("102")]),r("br"),r("span",{staticClass:"line-number"},[e._v("103")]),r("br"),r("span",{staticClass:"line-number"},[e._v("104")]),r("br"),r("span",{staticClass:"line-number"},[e._v("105")]),r("br"),r("span",{staticClass:"line-number"},[e._v("106")]),r("br"),r("span",{staticClass:"line-number"},[e._v("107")]),r("br"),r("span",{staticClass:"line-number"},[e._v("108")]),r("br"),r("span",{staticClass:"line-number"},[e._v("109")]),r("br"),r("span",{staticClass:"line-number"},[e._v("110")]),r("br"),r("span",{staticClass:"line-number"},[e._v("111")]),r("br"),r("span",{staticClass:"line-number"},[e._v("112")]),r("br"),r("span",{staticClass:"line-number"},[e._v("113")]),r("br"),r("span",{staticClass:"line-number"},[e._v("114")]),r("br"),r("span",{staticClass:"line-number"},[e._v("115")]),r("br"),r("span",{staticClass:"line-number"},[e._v("116")]),r("br"),r("span",{staticClass:"line-number"},[e._v("117")]),r("br"),r("span",{staticClass:"line-number"},[e._v("118")]),r("br"),r("span",{staticClass:"line-number"},[e._v("119")]),r("br"),r("span",{staticClass:"line-number"},[e._v("120")]),r("br"),r("span",{staticClass:"line-number"},[e._v("121")]),r("br"),r("span",{staticClass:"line-number"},[e._v("122")]),r("br")])])])}),[],!1,null,null,null);n.default=a.exports}}]);