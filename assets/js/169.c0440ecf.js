(window.webpackJsonp=window.webpackJsonp||[]).push([[169],{635:function(e,n,t){"use strict";t.r(n);var r=t(18),s=Object(r.a)({},(function(){var e=this,n=e.$createElement,t=e._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"wasi-网络汇编系统接口-node-js-api-文档"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#wasi-网络汇编系统接口-node-js-api-文档"}},[e._v("#")]),e._v(" wasi 网络汇编系统接口 | Node.js API 文档")]),e._v(" "),t("blockquote",[t("h2",{attrs:{id:"excerpt"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#excerpt"}},[e._v("#")]),e._v(" Excerpt")]),e._v(" "),t("p",[e._v("中英对照")])]),e._v(" "),t("hr"),e._v(" "),t("p",[t("a",{attrs:{href:"http://nodejs.cn/api-v12/wasi/webassembly_system_interface_wasi.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("中英对照"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("strong",[e._v("源代码:")]),e._v(" "),t("a",{attrs:{href:"https://github.com/nodejs/node/blob/v12.22.12/lib/wasi.js",target:"_blank",rel:"noopener noreferrer"}},[e._v("lib/wasi.js"),t("OutboundLink")],1)]),e._v(" "),t("p",[e._v("WASI API 提供了 "),t("a",{attrs:{href:"http://url.nodejs.cn/81GdrV",target:"_blank",rel:"noopener noreferrer"}},[e._v("WebAssembly 系统接口"),t("OutboundLink")],1),e._v("规范的实现。 WASI 让沙盒化的 WebAssembly 应用程序通过一系列类似 POSIX 的函数访问底层操作系统。")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("'use strict';\nconst fs = require('fs');\nconst { WASI } = require('wasi');\nconst wasi = new WASI({\n  args: process.argv,\n  env: process.env,\n  preopens: {\n    '/sandbox': '/some/real/path/that/wasm/can/access'\n  }\n});\nconst importObject = { wasi_snapshot_preview1: wasi.wasiImport };\n\n(async () => {\n  const wasm = await WebAssembly.compile(fs.readFileSync('./demo.wasm'));\n  const instance = await WebAssembly.instantiate(wasm, importObject);\n\n  wasi.start(instance);\n})();\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br"),t("span",{staticClass:"line-number"},[e._v("8")]),t("br"),t("span",{staticClass:"line-number"},[e._v("9")]),t("br"),t("span",{staticClass:"line-number"},[e._v("10")]),t("br"),t("span",{staticClass:"line-number"},[e._v("11")]),t("br"),t("span",{staticClass:"line-number"},[e._v("12")]),t("br"),t("span",{staticClass:"line-number"},[e._v("13")]),t("br"),t("span",{staticClass:"line-number"},[e._v("14")]),t("br"),t("span",{staticClass:"line-number"},[e._v("15")]),t("br"),t("span",{staticClass:"line-number"},[e._v("16")]),t("br"),t("span",{staticClass:"line-number"},[e._v("17")]),t("br"),t("span",{staticClass:"line-number"},[e._v("18")]),t("br")])]),t("p",[e._v("要运行上面的示例，则新建一个名为 "),t("code",[e._v("demo.wat")]),e._v(" 的 WebAssembly 文本格式文件：")]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('(module\n    ;; Import the required fd_write WASI function which will write the given io vectors to stdout\n    ;; The function signature for fd_write is:\n    ;; (File Descriptor, *iovs, iovs_len, nwritten) -> Returns number of bytes written\n    (import "wasi_snapshot_preview1" "fd_write" (func $fd_write (param i32 i32 i32 i32) (result i32)))\n\n    (memory 1)\n    (export "memory" (memory 0))\n\n    ;; Write \'hello world\\n\' to memory at an offset of 8 bytes\n    ;; Note the trailing newline which is required for the text to appear\n    (data (i32.const 8) "hello world\\n")\n\n    (func $main (export "_start")\n        ;; Creating a new io vector within linear memory\n        (i32.store (i32.const 0) (i32.const 8))  ;; iov.iov_base - This is a pointer to the start of the \'hello world\\n\' string\n        (i32.store (i32.const 4) (i32.const 12))  ;; iov.iov_len - The length of the \'hello world\\n\' string\n\n        (call $fd_write\n            (i32.const 1) ;; file_descriptor - 1 for stdout\n            (i32.const 0) ;; *iovs - The pointer to the iov array, which is stored at memory location 0\n            (i32.const 1) ;; iovs_len - We\'re printing 1 string stored in an iov - so one.\n            (i32.const 20) ;; nwritten - A place in memory to store the number of bytes written\n        )\n        drop ;; Discard the number of bytes written from the top of the stack\n    )\n)\n')])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br"),t("span",{staticClass:"line-number"},[e._v("8")]),t("br"),t("span",{staticClass:"line-number"},[e._v("9")]),t("br"),t("span",{staticClass:"line-number"},[e._v("10")]),t("br"),t("span",{staticClass:"line-number"},[e._v("11")]),t("br"),t("span",{staticClass:"line-number"},[e._v("12")]),t("br"),t("span",{staticClass:"line-number"},[e._v("13")]),t("br"),t("span",{staticClass:"line-number"},[e._v("14")]),t("br"),t("span",{staticClass:"line-number"},[e._v("15")]),t("br"),t("span",{staticClass:"line-number"},[e._v("16")]),t("br"),t("span",{staticClass:"line-number"},[e._v("17")]),t("br"),t("span",{staticClass:"line-number"},[e._v("18")]),t("br"),t("span",{staticClass:"line-number"},[e._v("19")]),t("br"),t("span",{staticClass:"line-number"},[e._v("20")]),t("br"),t("span",{staticClass:"line-number"},[e._v("21")]),t("br"),t("span",{staticClass:"line-number"},[e._v("22")]),t("br"),t("span",{staticClass:"line-number"},[e._v("23")]),t("br"),t("span",{staticClass:"line-number"},[e._v("24")]),t("br"),t("span",{staticClass:"line-number"},[e._v("25")]),t("br"),t("span",{staticClass:"line-number"},[e._v("26")]),t("br"),t("span",{staticClass:"line-number"},[e._v("27")]),t("br")])]),t("p",[e._v("使用 "),t("a",{attrs:{href:"https://github.com/WebAssembly/wabt",target:"_blank",rel:"noopener noreferrer"}},[e._v("wabt"),t("OutboundLink")],1),e._v(" 将 "),t("code",[e._v(".wat")]),e._v(" 编译为 "),t("code",[e._v(".wasm")])]),e._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("$ wat2wasm demo.wat\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br")])]),t("p",[e._v("运行此示例需要 "),t("code",[e._v("--experimental-wasi-unstable-preview1")]),e._v(" 和 "),t("code",[e._v("--experimental-wasm-bigint")]),e._v(" CLI 参数。")]),e._v(" "),t("h3",{attrs:{id:"wasi-类"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#wasi-类"}},[e._v("#")]),e._v(" "),t("code",[e._v("WASI")]),e._v(" 类"),t("a",{attrs:{href:"http://nodejs.cn/api-v12/wasi.html#class-wasi",target:"_blank",rel:"noopener noreferrer"}},[e._v("#"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("a",{attrs:{href:"http://nodejs.cn/api-v12/wasi/class_wasi.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("中英对照"),t("OutboundLink")],1)]),e._v(" "),t("p",[e._v("新增于: v12.16.0")]),e._v(" "),t("p",[t("code",[e._v("WASI")]),e._v(" 类提供了 WASI 系统调用 API 和其他方便的方法来使用基于 WASI 的应用程序。 每个 "),t("code",[e._v("WASI")]),e._v(" 实例代表一个不同的沙箱环境。")]),e._v(" "),t("h4",{attrs:{id:"new-wasi-options"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#new-wasi-options"}},[e._v("#")]),e._v(" "),t("code",[e._v("new WASI([options])")]),t("a",{attrs:{href:"http://nodejs.cn/api-v12/wasi.html#new-wasioptions",target:"_blank",rel:"noopener noreferrer"}},[e._v("#"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("a",{attrs:{href:"http://nodejs.cn/api-v12/wasi/new_wasi_options.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("中英对照"),t("OutboundLink")],1)]),e._v(" "),t("p",[e._v("新增于: v12.16.0")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("options")]),e._v(" "),t("a",{attrs:{href:"http://url.nodejs.cn/jzn6Ao",target:"_blank",rel:"noopener noreferrer"}},[t("Object",[t("OutboundLink")],1)],1),e._v(" "),t("ul",[t("li",[t("code",[e._v("args")]),e._v(" "),t("a",{attrs:{href:"http://url.nodejs.cn/ZJSz23",target:"_blank",rel:"noopener noreferrer"}},[t("Array",[t("OutboundLink")],1)],1),e._v(" 第一个参数是 WASI 命令本身的虚拟路径。 "),t("strong",[e._v("默认值:")]),e._v(" "),t("code",[e._v("[]")]),e._v("。")]),e._v(" "),t("li",[t("code",[e._v("env")]),e._v(" "),t("a",{attrs:{href:"http://url.nodejs.cn/jzn6Ao",target:"_blank",rel:"noopener noreferrer"}},[t("Object",[t("OutboundLink")],1)],1),e._v(" 类似于 "),t("code",[e._v("process.env")]),e._v(" 的对象，WebAssembly 应用程序将其视为其环境。 "),t("strong",[e._v("默认值:")]),e._v(" "),t("code",[e._v("{}")]),e._v("。")]),e._v(" "),t("li",[t("code",[e._v("preopens")]),e._v(" "),t("a",{attrs:{href:"http://url.nodejs.cn/jzn6Ao",target:"_blank",rel:"noopener noreferrer"}},[t("Object",[t("OutboundLink")],1)],1),e._v(" 此对象表示 WebAssembly 应用程序的沙箱目录结构。 "),t("code",[e._v("preopens")]),e._v(" 的字符串键被视为沙箱中的目录。 "),t("code",[e._v("preopens")]),e._v(" 中对应的值是宿主机上这些目录的真实路径。")]),e._v(" "),t("li",[t("code",[e._v("returnOnExit")]),e._v(" "),t("a",{attrs:{href:"http://url.nodejs.cn/jFbvuT",target:"_blank",rel:"noopener noreferrer"}},[t("boolean",[t("OutboundLink")],1)],1),e._v(" 默认情况下，WASI 应用程序通过 "),t("code",[e._v("__wasi_proc_exit()")]),e._v(" 函数终止 Node.js 进程。 将此选项设置为 "),t("code",[e._v("true")]),e._v(" 会导致 "),t("code",[e._v("wasi.start()")]),e._v(" 返回退出代码而不是终止进程。 "),t("strong",[e._v("默认值:")]),e._v(" "),t("code",[e._v("false")]),e._v("。")]),e._v(" "),t("li",[t("code",[e._v("stdin")]),e._v(" "),t("a",{attrs:{href:"http://url.nodejs.cn/SXbo1v",target:"_blank",rel:"noopener noreferrer"}},[t("integer",[t("OutboundLink")],1)],1),e._v(" 在 WebAssembly 应用程序中用作标准输入的文件描述符。 "),t("strong",[e._v("默认值:")]),e._v(" "),t("code",[e._v("0")]),e._v("。")]),e._v(" "),t("li",[t("code",[e._v("stdout")]),e._v(" "),t("a",{attrs:{href:"http://url.nodejs.cn/SXbo1v",target:"_blank",rel:"noopener noreferrer"}},[t("integer",[t("OutboundLink")],1)],1),e._v(" 在 WebAssembly 应用程序中用作标准输出的文件描述符。 "),t("strong",[e._v("默认值:")]),e._v(" "),t("code",[e._v("1")]),e._v("。")]),e._v(" "),t("li",[t("code",[e._v("stderr")]),e._v(" "),t("a",{attrs:{href:"http://url.nodejs.cn/SXbo1v",target:"_blank",rel:"noopener noreferrer"}},[t("integer",[t("OutboundLink")],1)],1),e._v(" 在 WebAssembly 应用程序中用作标准错误的文件描述符。 "),t("strong",[e._v("默认值:")]),e._v(" "),t("code",[e._v("2")]),e._v("。")])])])]),e._v(" "),t("h4",{attrs:{id:"wasi-start-instance"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#wasi-start-instance"}},[e._v("#")]),e._v(" "),t("code",[e._v("wasi.start(instance)")]),t("a",{attrs:{href:"http://nodejs.cn/api-v12/wasi.html#wasistartinstance",target:"_blank",rel:"noopener noreferrer"}},[e._v("#"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("a",{attrs:{href:"http://nodejs.cn/api-v12/wasi/wasi_start_instance.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("中英对照"),t("OutboundLink")],1)]),e._v(" "),t("p",[e._v("新增于: v12.16.0")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("instance")]),e._v(" "),t("a",{attrs:{href:"http://url.nodejs.cn/dpJWED",target:"_blank",rel:"noopener noreferrer"}},[e._v("<WebAssembly.Instance>"),t("OutboundLink")],1)])]),e._v(" "),t("p",[e._v("尝试通过调用 "),t("code",[e._v("_start()")]),e._v(" 导出来开始执行 "),t("code",[e._v("instance")]),e._v(" 作为 WASI 命令。 如果 "),t("code",[e._v("instance")]),e._v(" 不包含 "),t("code",[e._v("_start()")]),e._v(" 导出，或者 "),t("code",[e._v("instance")]),e._v(" 包含 "),t("code",[e._v("_initialize()")]),e._v(" 导出，则抛出异常。")]),e._v(" "),t("p",[t("code",[e._v("start()")]),e._v(" 要求 "),t("code",[e._v("instance")]),e._v(" 导出名为 "),t("code",[e._v("memory")]),e._v(" 的 "),t("a",{attrs:{href:"http://url.nodejs.cn/oNpEVb",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("WebAssembly.Memory")]),t("OutboundLink")],1),e._v("。 如果 "),t("code",[e._v("instance")]),e._v(" 没有 "),t("code",[e._v("memory")]),e._v(" 导出，则抛出异常。")]),e._v(" "),t("p",[e._v("如果 "),t("code",[e._v("start()")]),e._v(" 被多次调用，则抛出异常。")]),e._v(" "),t("h4",{attrs:{id:"wasi-initialize-instance"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#wasi-initialize-instance"}},[e._v("#")]),e._v(" "),t("code",[e._v("wasi.initialize(instance)")]),t("a",{attrs:{href:"http://nodejs.cn/api-v12/wasi.html#wasiinitializeinstance",target:"_blank",rel:"noopener noreferrer"}},[e._v("#"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("a",{attrs:{href:"http://nodejs.cn/api-v12/wasi/wasi_initialize_instance.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("中英对照"),t("OutboundLink")],1)]),e._v(" "),t("p",[e._v("新增于: v12.19.0")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("instance")]),e._v(" "),t("a",{attrs:{href:"http://url.nodejs.cn/dpJWED",target:"_blank",rel:"noopener noreferrer"}},[e._v("<WebAssembly.Instance>"),t("OutboundLink")],1)])]),e._v(" "),t("p",[e._v("尝试通过调用 "),t("code",[e._v("_initialize()")]),e._v(" 导出（如果存在）将 "),t("code",[e._v("instance")]),e._v(" 初始化为 WASI 反应器。 如果 "),t("code",[e._v("instance")]),e._v(" 包含 "),t("code",[e._v("_start()")]),e._v(" 导出，则抛出异常。")]),e._v(" "),t("p",[t("code",[e._v("initialize()")]),e._v(" 要求 "),t("code",[e._v("instance")]),e._v(" 导出名为 "),t("code",[e._v("memory")]),e._v(" 的 "),t("a",{attrs:{href:"http://url.nodejs.cn/oNpEVb",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("WebAssembly.Memory")]),t("OutboundLink")],1),e._v("。 如果 "),t("code",[e._v("instance")]),e._v(" 没有 "),t("code",[e._v("memory")]),e._v(" 导出，则抛出异常。")]),e._v(" "),t("p",[e._v("如果 "),t("code",[e._v("initialize()")]),e._v(" 被多次调用，则抛出异常。")]),e._v(" "),t("h4",{attrs:{id:"wasi-wasiimport"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#wasi-wasiimport"}},[e._v("#")]),e._v(" "),t("code",[e._v("wasi.wasiImport")]),t("a",{attrs:{href:"http://nodejs.cn/api-v12/wasi.html#wasiwasiimport",target:"_blank",rel:"noopener noreferrer"}},[e._v("#"),t("OutboundLink")],1)]),e._v(" "),t("p",[t("a",{attrs:{href:"http://nodejs.cn/api-v12/wasi/wasi_wasiimport.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("中英对照"),t("OutboundLink")],1)]),e._v(" "),t("p",[e._v("新增于: v12.16.0")]),e._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"http://url.nodejs.cn/jzn6Ao",target:"_blank",rel:"noopener noreferrer"}},[t("Object",[t("OutboundLink")],1)],1)])]),e._v(" "),t("p",[t("code",[e._v("wasiImport")]),e._v(" 是实现 WASI 系统调用 API 的对象。 此对象应在 "),t("a",{attrs:{href:"http://url.nodejs.cn/dpJWED",target:"_blank",rel:"noopener noreferrer"}},[t("code",[e._v("WebAssembly.Instance")]),t("OutboundLink")],1),e._v(" 实例化期间作为 "),t("code",[e._v("wasi_snapshot_preview1")]),e._v(" 导入传入。")])])}),[],!1,null,null,null);n.default=s.exports}}]);