(window.webpackJsonp=window.webpackJsonp||[]).push([[152],{618:function(e,n,s){"use strict";s.r(n);var a=s(18),t=Object(a.a)({},(function(){var e=this,n=e.$createElement,s=e._self._c||n;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"policy-安全策略-node-js-api-文档"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#policy-安全策略-node-js-api-文档"}},[e._v("#")]),e._v(" policy 安全策略 | Node.js API 文档")]),e._v(" "),s("blockquote",[s("h2",{attrs:{id:"excerpt"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#excerpt"}},[e._v("#")]),e._v(" Excerpt")]),e._v(" "),s("p",[e._v("中英对照")])]),e._v(" "),s("hr"),e._v(" "),s("p",[s("a",{attrs:{href:"http://nodejs.cn/api-v12/policy/policies.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("中英对照"),s("OutboundLink")],1)]),e._v(" "),s("p",[e._v("Node.js 包含了对创建加载代码的策略的实验性支持。")]),e._v(" "),s("p",[e._v("策略是一个安全特性，旨在保证 Node.js 能够加载哪些代码。 策略的使用假定策略文件的安全实践，例如确保 Node.js 应用程序不能使用文件权限覆盖策略文件。")]),e._v(" "),s("p",[e._v("一个典型的设置是将策略文件创建为与运行 Node.js 的用户 ID 不同的用户 ID，并向运行 Node.js 的用户 ID 授予读取权限。")]),e._v(" "),s("h3",{attrs:{id:"启用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#启用"}},[e._v("#")]),e._v(" 启用"),s("a",{attrs:{href:"http://nodejs.cn/api-v12/policy.html#enabling",target:"_blank",rel:"noopener noreferrer"}},[e._v("#"),s("OutboundLink")],1)]),e._v(" "),s("p",[s("a",{attrs:{href:"http://nodejs.cn/api-v12/policy/enabling.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("中英对照"),s("OutboundLink")],1)]),e._v(" "),s("p",[s("code",[e._v("--experimental-policy")]),e._v(" 标志可用于在加载模块时启用策略特性。")]),e._v(" "),s("p",[e._v("一旦设置好，则所有模块都必须符合传给标志的策略清单文件：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("node --experimental-policy=policy.json app.js\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("p",[e._v("策略清单将用于对 Node.js 加载的代码实施约束。")]),e._v(" "),s("p",[e._v("为了减少对磁盘上策略文件的篡改，可以通过 "),s("code",[e._v("--policy-integrity")]),e._v(" 提供策略文件本身的完整性。 这允许运行 "),s("code",[e._v("node")]),e._v(" 并断言策略文件内容，即使文件在磁盘上被更改。")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('node --experimental-policy=policy.json --policy-integrity="sha384-SggXRQHwCG8g+DktYYzxkXRIkTiEYWBHqev0xnpCxYlqMBufKZHAHQM3/boDaI/0" app.js\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("h3",{attrs:{id:"特性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#特性"}},[e._v("#")]),e._v(" 特性"),s("a",{attrs:{href:"http://nodejs.cn/api-v12/policy.html#features",target:"_blank",rel:"noopener noreferrer"}},[e._v("#"),s("OutboundLink")],1)]),e._v(" "),s("h4",{attrs:{id:"错误的行为"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#错误的行为"}},[e._v("#")]),e._v(" 错误的行为"),s("a",{attrs:{href:"http://nodejs.cn/api-v12/policy.html#error-behavior",target:"_blank",rel:"noopener noreferrer"}},[e._v("#"),s("OutboundLink")],1)]),e._v(" "),s("p",[s("a",{attrs:{href:"http://nodejs.cn/api-v12/policy/error_behavior.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("中英对照"),s("OutboundLink")],1)]),e._v(" "),s("p",[e._v("当策略检查失败时，Node.js 默认会抛出错误。 通过在策略清单中定义 “onerror” 字段，可以将错误行为更改为几种可能性之一。 以下值可用于更改行为：")]),e._v(" "),s("ul",[s("li",[s("code",[e._v('"exit"')]),e._v(": 将立即退出进程。 不允许运行任何清理代码。")]),e._v(" "),s("li",[s("code",[e._v('"log"')]),e._v(": 将在发生故障的地方记录错误。")]),e._v(" "),s("li",[s("code",[e._v('"throw"')]),e._v(": 将在失败的地方抛出 JS 错误。 这是默认值。")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('{\n  "onerror": "log",\n  "resources": {\n    "./app/checked.js": {\n      "integrity": "sha384-SggXRQHwCG8g+DktYYzxkXRIkTiEYWBHqev0xnpCxYlqMBufKZHAHQM3/boDaI/0"\n    }\n  }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br")])]),s("h4",{attrs:{id:"完整性检查"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#完整性检查"}},[e._v("#")]),e._v(" 完整性检查"),s("a",{attrs:{href:"http://nodejs.cn/api-v12/policy.html#integrity-checks",target:"_blank",rel:"noopener noreferrer"}},[e._v("#"),s("OutboundLink")],1)]),e._v(" "),s("p",[s("a",{attrs:{href:"http://nodejs.cn/api-v12/policy/integrity_checks.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("中英对照"),s("OutboundLink")],1)]),e._v(" "),s("p",[e._v("策略文件必须使用与绝对 URL 关联的浏览器"),s("a",{attrs:{href:"http://url.nodejs.cn/JDfR74",target:"_blank",rel:"noopener noreferrer"}},[e._v("完整性属性"),s("OutboundLink")],1),e._v("兼容的子资源完整性字符串的完整性检查。")]),e._v(" "),s("p",[e._v("如果资源与清单中列出的完整性不匹配，则会抛出错误。")]),e._v(" "),s("p",[e._v("允许加载文件 "),s("code",[e._v("checked.js")]),e._v(" 的示例策略文件：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('{\n  "resources": {\n    "./app/checked.js": {\n      "integrity": "sha384-SggXRQHwCG8g+DktYYzxkXRIkTiEYWBHqev0xnpCxYlqMBufKZHAHQM3/boDaI/0"\n    }\n  }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br")])]),s("p",[e._v("策略清单中列出的每个资源都可以采用以下格式之一来确定其位置：")]),e._v(" "),s("p",[e._v("当加载资源时，整个 URL 必须匹配，包括搜索参数和哈希片段。 尝试加载 "),s("code",[e._v("./a.js")]),e._v(" 时不会使用 "),s("code",[e._v("./a.js?b")]),e._v("，反之亦然。")]),e._v(" "),s("p",[e._v("要生成完整性字符串，则可以使用 "),s("code",[e._v('printf "sha384-$(cat checked.js | openssl dgst -sha384 -binary | base64)"')]),e._v(" 等脚本。")]),e._v(" "),s("p",[e._v("完整性可以指定为布尔值 "),s("code",[e._v("true")]),e._v("，以接受任何对本地开发有用的资源主体。 不建议在生产中这样做，因为它会允许资源的意外更改被认为是有效的。")]),e._v(" "),s("h4",{attrs:{id:"依赖项重定向"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#依赖项重定向"}},[e._v("#")]),e._v(" 依赖项重定向"),s("a",{attrs:{href:"http://nodejs.cn/api-v12/policy.html#dependency-redirection",target:"_blank",rel:"noopener noreferrer"}},[e._v("#"),s("OutboundLink")],1)]),e._v(" "),s("p",[s("a",{attrs:{href:"http://nodejs.cn/api-v12/policy/dependency_redirection.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("中英对照"),s("OutboundLink")],1)]),e._v(" "),s("p",[e._v("应用程序可能需要发布模块的补丁版本或阻止模块允许所有模块访问所有其他模块。 可以通过拦截加载希望被替换的模块的尝试来使用重定向。")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('{\n  "builtins": [],\n  "resources": {\n    "./app/checked.js": {\n      "dependencies": {\n        "fs": true,\n        "os": "./app/node_modules/alt-os"\n      }\n    }\n  }\n}\n')])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br")])]),s("p",[e._v("可以指定依赖项映射的布尔值 "),s("code",[e._v("true")]),e._v(" 以允许模块加载任何说明符而无需重定向。 这对本地开发很有用，并且在生产中可能有一些有效的用途，但只有在审核模块以确保其行为有效后才应谨慎使用。")]),e._v(" "),s("h5",{attrs:{id:"示例-修补依赖项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#示例-修补依赖项"}},[e._v("#")]),e._v(" 示例：修补依赖项"),s("a",{attrs:{href:"http://nodejs.cn/api-v12/policy.html#example-patched-dependency",target:"_blank",rel:"noopener noreferrer"}},[e._v("#"),s("OutboundLink")],1)]),e._v(" "),s("p",[s("a",{attrs:{href:"http://nodejs.cn/api-v12/policy/example_patched_dependency.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("中英对照"),s("OutboundLink")],1)]),e._v(" "),s("p",[e._v("重定向的依赖可以提供适合应用程序的衰减或修改功能。 例如，通过封装原始记录有关函数持续时间的计时数据：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("const original = require('fn');\nmodule.exports = function fn(...args) {\n  console.time();\n  try {\n    return new.target ?\n      Reflect.construct(original, args) :\n      Reflect.apply(original, this, args);\n  } finally {\n    console.timeEnd();\n  }\n};\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);