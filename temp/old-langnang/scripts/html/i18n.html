<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>i18n</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="row">
            <label for="files_json" class="btn btn-default">json</label>
            <label for="files_resx" class="btn btn-default">resx</label>
            <input type="file" id="files_json" accept="application/json" multiple style="display: none;" />
            <input type="file" id="files_resx" accept="application/resx" multiple style="display: none;" />
            <button onclick="tableToExcel('table')">导出</button>
            <div id="table"></div>
        </div>
    </div>
    <script type="text/javascript">
        "use strict";
        $(document).ready(function () {
            var inputElement = document.getElementById("files");
            var tableElement = document.getElementById("table");
            $(document).on("change", "input[type=file]", function (e) {
                handleFiles($(e.target)[0].files);
            })

            // 读取文件内容
            function handleFiles(files) {
                console.log(files);
                let promiseArray = [];
                for (let key in files) {
                    if (!["length", "item"].includes(key)) {
                        promiseArray.push(new Promise((resolve, reject) => {
                            const file = files[key];
                            const file_split = file.name.split(".");
                            var reader = new FileReader();//这里是核心！！！读取操作就是由它完成的。
                            reader.readAsText(file);//读取文件的内容
                            reader.onload = function () {
                                //当读取完成之后会回调这个函数，然后此时文件的内容存储到了result中。直接操作即可。
                                resolve(Object.assign({
                                    name: file.name,
                                    lastModified: file.lastModified,
                                    lastModifiedDate: file.lastModifiedDate,
                                    size: file.size,
                                    type: file.type,
                                    webkitRelativePath: file.webkitRelativePath
                                }, {
                                    text: this.result,
                                    filetype: file_split[file_split.length - 1],
                                    filename: file_split.length > 2 ? file_split.slice(0, file_split.length - 2).join(".") : null,
                                    i18n: file_split[file_split.length - 2],
                                }));
                            }
                        }))
                    }
                }
                Promise.all(promiseArray).then(res => {
                    let result = res.map(value => {
                        if (value.filetype == "json") {
                            value.content = JSON.parse(value.text);
                        } else if (value.filetype == "resx") {
                            const reg = /\<data name=\"(.+?)\" xml\:space=\"preserve\"\>\s+\<value\>(.+?)\<\/value\>/;
                            const reg_g = /\<data name=\"(.+?)\" xml\:space=\"preserve\"\>\s+\<value\>(.+?)\<\/value\>/g;
                            value.content = value.text.match(reg_g).reduce((total, value) => {
                                total[value.match(reg)[1]] = value.match(reg)[2]
                                return total;
                            }, {});
                        }
                        return value;
                    })
                    result = buildContent(result);
                    buildTable(result);
                })
            }

            function buildContent(args) {
                let res = {};
                let resArgs = [];
                args.forEach(element => {
                    if (!res[element.i18n]) {
                        res[element.i18n] = {};
                    }
                    if (element.filename) {
                        res[element.i18n][element.filename] = element.content;
                    } else {
                        res[element.i18n] = Object.assign(res[element.i18n] || {}, element.content);
                    }
                });
                for (let key in res) {
                    resArgs.push({ i18n: key, content: res[key] })
                }
                return resArgs;
            };

            function buildTable(args) {
                let table = `
      <table class="table table-striped table-bordered table-hover">
        ${buildThead(args)}
        ${buildTbody(args)}
      </table>
      `;
                table += ``;
                tableElement.innerHTML = table;
            }

            function buildThead(args) {
                return `
      <thead>
        <tr>
          <td></td>
          ${args.reduce((total, value) => total + `<td>${value.i18n}</td>`, '')}
        </tr>
      </thead>
      `;
            }

            function buildTbody(args) {
                let keys = getAllKeys(args);
                // console.log(keys);
                let tbody = `<tbody>`;
                tbody += keys.reduce((total, key) => total + buildTr(key, args), '');
                // for (let key in json) {
                //   if (["Array", "Object"].includes(typeOf(json[key]))) {
                //     tbody += buildTbody(parent ? parent + '.' + key : key, json[key]);
                //   } else {
                //     tbody += buildTr(parent ? parent + '.' + key : key, json[key]);
                //   }
                // }
                tbody += `</tbody>`;
                return tbody;
            }

            function buildTr(key, args) {
                let tr = `<tr><td>${key}</td>${args.reduce((totalTr, file) => {
                    totalTr += `<td>${getValue(key, file.content)}</td>`;
                    return totalTr;
                }, '')}</td>`;
                return tr;
            }

            function getAllKeys(args) {
                let keys = args.reduce((total, val) => [...total, ...recurveGetKeys(null, val.content)], []);
                keys = [...new Set(keys)];
                return keys;
            }

            function recurveGetKeys(parent, json) {
                let keys = [];
                for (let key in json) {
                    if (["Array", "Object"].includes(typeOf(json[key]))) {
                        keys = keys.concat(recurveGetKeys(parent ? parent + '.' + key : key, json[key]));
                    } else {
                        keys.push(parent ? parent + '.' + key : key);
                    }
                }
                return keys;
            }

            function typeOf(val) {
                const type = Object.prototype.toString.call(val);
                return type.substring(8, type.length - 1);
            }

            function getValue(key, json) {
                let keyDep = key.split(".");
                // console.log(key, keyDep);
                return keyDep.reduce((total, childKey) => total[childKey], json);
            }

            function tableToExcel(tableID) {
                var excelContent = $("#" + tableID).html();
                var excelFile = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:x='urn:schemas-microsoft-com:office:excel' xmlns='http://www.w3.org/TR/REC-html40'>";
                excelFile += "<head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head>";
                excelFile += "<body>";
                excelFile += excelContent;
                excelFile += "</body>";
                excelFile += "</html>";
                var link = "data:application/vnd.ms-excel;base64," + base64(excelFile);
                var a = document.createElement("a");
                var fileName = $("#filename").val() || 'i18n';
                a.download = fileName + ".xls";
                a.href = link;
                a.click();
            }

            function base64(content) {
                return window.btoa(unescape(encodeURIComponent(content)));
            }
        })
    </script>
</body>

</html>
