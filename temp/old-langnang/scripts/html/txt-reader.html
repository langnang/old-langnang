<!-- 
*******************************************************************
***         __                                                  ***
***        / /   ____  ____  ____  ____  ____  ____  ____ _     ***
***       / /   / __ `/ __ \/ __ `/ __ \/ __ `/ __ \/ __ `/     ***
***      / /___/ /_/ / / / / /_/ / / / / /_/ / / / / /_/ /      ***
***     /_____/\__,_/_/ /_/\__, /_/ /_/\__,_/_/ /_/\__, /       ***
***                       /____/                  /____/        ***
***                                                             ***
***                          TxtReader                          ***
*******************************************************************

TXT 文本阅读器/本地小说阅读器
- 目录
	- [x] 打开过的文件目录
	- [x] 文件目录
- 分页
	- [x] 上下页
	- [x] 首末页
	- [x] 按键上下页
- 记忆
	- [x] 打开过的文件
	- [x] 位置


 -->
<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
	<title>TxtReader</title>
	<meta name="description" content="TXT 文本阅读器">
	<meta name="keywords" content="txt reader">
	<!-- Element -->
	<!-- <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css"> -->
	<!--    https://v3.bootcss.com/-->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" />
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
	<style>
		#catalog {}

		#content {
			font-family: '微软雅黑';
			font-size: 18px;
		}

	</style>
</head>

<body>
	<div id="app" class="container">
		<div class="row">
			<form class="form-inline">
				<div class="form-group" v-if="!file.name">
					<label for="files_txt" class="btn btn-default">选择文件</label>
					<input type="file" id="files_txt" class="form-control" accept=".txt" style="display: none;"
						@change="onFileChange" />
				</div>
				<div class="form-group">
					<label for="fontFamily">字体</label>
					<select id="fontFamily" class="form-control">
						<option>金梅火材棒美工字</option>
						<option>黑体</option>
						<option>王汉宗叠圆体繁</option>
						<option selected>微软雅黑</option>
					</select>
				</div>
				<div class="form-group">
					<label for="fontSize">字号</label>
					<select id="fontSize" class="form-control" v-model="style.fontSize">
						<option v-for="value in [14,16,18,20,24,28,32,36,72]" :value="value">{{value}}px</option>
					</select>
				</div>
				<div class="form-group">
					<label for="fontSize">文本色</label>
					<select id="fontSize" class="form-control" v-model="style.fontColor">
						<option v-for="value in ['dark','muted','primary','success','info','warning','danger']" :value="value">
							{{value}}</option>
					</select>
				</div>
				<div class="form-group">
					<label for="theme">背景色</label>
					<select id="theme" class="form-control" v-model="style.bgColor">
						<option v-for="value in ['white','primary','success','info','warning','danger']" :value="value">
							{{value}}</option>
					</select>
				</div>
			</form>

			<div id="table"></div>
			<ul class="pager" v-if="content">
				<li class="previous"><a :href="'#'+(file.chapter-1)" @click="file.chapter--" @keyup.37="file.chapter++">上一章</a>
				</li>
				<li><a :href="'#'" @click="file.chapter=0">首章</a></li>
				<li><a :href="'#'" @click="file.chapter=null">目录</a></li>
				<li><a :href="'#'" @click="file.chapter=file.catalog.length-1">末章</a></li>
				<li class="next"><a :href="'#'+(file.chapter+1)" @click="file.chapter++" @keyup.39="file.chapter++">下一章</a>
				</li>
			</ul>
			<div id="content" v-html="content" :class='["text-"+style.fontColor,"bg-"+style.bgColor]'
				:style='{fontSize:style.fontSize+"px",}' @keyup.39="file.chapter++">
			</div>
			<nav class="text-center" v-if=false>
				<ul class="pagination">
					<li class="previous"><a :href="'#'+(file.chapter-1)" @click="file.chapter--"><span
								aria-hidden="true">&larr;</span>上一章</a>
					</li>
					<li> <a href="#"> <span class="glyphicon glyphicon-step-backward"></span> </a> </li>
					<li><a :href="'#'+(file.chapter-1)" @click="file.chapter--"> <span
								class="glyphicon glyphicon-backward"></span> </a>
					</li>
					<li><a href="#">1</a></li>
					<li><a href="#">2</a></li>
					<li><a href="#">3</a></li>
					<li><a href="#">4</a></li>
					<li><a href="#">5</a></li>
					<li> <a href="#"> <span class="glyphicon glyphicon-forward"></span> </a> </li>
					<li><a href="#"> <span class="glyphicon glyphicon-step-forward"></span> </a> </li>
					<li class="next"><a :href="'#'+(file.chapter+1)" @click="file.chapter++">下一章 <span
								aria-hidden="true">&rarr;</span></a>
					</li>
				</ul>
			</nav>

			<ul class="pager" v-if="content">
				<li class="previous"><a :href="'#'+(file.chapter-1)" @click="file.chapter--">上一章</a>
				</li>
				<li><a :href="'#'" @click="file.chapter=0">首章</a></li>
				<li><a :href="'#'" @click="file.chapter=null">目录</a></li>
				<li><a :href="'#'" @click="file.chapter=file.catalog.length-1">末章</a></li>
				</li>
				<li class="next"><a :href="'#'+(file.chapter+1)" @click="file.chapter++">下一章</a>
				</li>
			</ul>
		</div>
		<div class="row list-group" v-if="!catalog">
			<button v-for="(item,key) in storages" class="col-md-3 col-sm-6 col-xs-12 list-group-item"
				style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;" @click="selectFile(key)">
				{{key}}: {{item.chapter?item.catalog[item.chapter]:''}} | {{item.catalog[item.catalog.length-1]}}
			</button>
		</div>
		<div class="row list-group" v-if="!content">
			<a v-for="(item,index) in catalog" :href="'#'" :title="item" @click="file.chapter=index">
				<div class="col-md-3 col-sm-6 col-xs-12 list-group-item"
					style="white-space: nowrap;overflow: hidden;text-overflow: ellipsis;">
					{{item}}</div>
			</a>
		</div>
	</div>
	<!-- Vue -->
	<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12"></script>
	<!-- Element -->
	<!-- <script src="https://unpkg.com/element-ui/lib/index.js"></script> -->
	<script type="text/javascript">
		"use strict";

		new Vue({
			el: "#app",
			data: {
				storages: JSON.parse(localStorage.getItem("TxtReader") || '{}'),
				file: {
				},
				style: {
					fontFamily: "微软雅黑",
					fontSize: 20,
					fontColor: "dark",
					bgColor: "white",
				},
			},
			computed: {
				catalog: function () {
					if (!this.$data.file.text) {
						return;
					}
					let text = this.$data.file.text;
					const reg = /^第(.*)章/;
					// const reg_g = /第(.*?)章(.*?)\r/g;
					const reg_g = /第(.*)章(.*)/g;
					return text.match(reg_g);
				},
				content: function () {
					if (!this.$data.file.chapter) {
						return;
					}
					let index = this.$data.file.chapter;
					let content = this.$data.file.text.substring(this.$data.file.text.indexOf(this.catalog[index]), this.$data.file.text.indexOf(this.catalog[index + 1]));
					content = `<h1 class="text-center" style="font-size:48px;font-weight:blod;">${this.catalog[index]}</h1>` + content.replace(/\n/g, '<br/>');
					return content;
				}
			},
			mounted() {
				let _this = this;
				document.onkeydown = function (e) {
					switch (e.keyCode) {
						case 37:
							if (_this.$data.file.chapter) {
								_this.$data.file.chapter--;
							}
							break;
						case 39:
							if (_this.$data.file.chapter) {
								_this.$data.file.chapter++;
							}
							break;
						default:
							break;
					}
					let key = window.event.keyCode;
					// if (key == 83 && event.ctrlKey) {//== 83 && event.ctrlKey
					// window.event.preventDefault() //关闭浏览器快捷键
					// _this.save_onkeydown();//;saveProject1()
					// }
				};
			},
			methods: {
				selectFile(key) {
					this.file = this.storages[key];
				},
				onFileChange: function (e) {
					console.log(e.target.files);
					let files = e.target.files;
					let promiseArray = [];
					for (let key in files) {
						if (!["length", "item"].includes(key)) {
							promiseArray.push(new Promise((resolve, reject) => {
								const file = files[key];
								const file_split = file.name.split(".");
								var reader = new FileReader();//这里是核心！！！读取操作就是由它完成的。
								reader.readAsText(file, 'UTF-8');//读取文件的内容
								reader.onload = function () {
									//当读取完成之后会回调这个函数，然后此时文件的内容存储到了result中。直接操作即可。
									resolve(Object.assign({
										name: file.name,
										lastModified: file.lastModified,
										lastModifiedDate: file.lastModifiedDate,
										size: file.size,
										type: file.type,
										webkitRelativePath: file.webkitRelativePath
									}, {
										text: this.result,
										chapter: null,
										filetype: file_split[file_split.length - 1],
										filename: file_split.length > 2 ? file_split.slice(0, file_split.length - 2).join(".") : file_split[file_split.length - 2],
										i18n: file_split.length > 2 ? file_split[file_split.length - 2] : null,
										catalog: getCatalog(this.result),
									}));
								}
							}))
						}
					}
					Promise.all(promiseArray).then(res => {
						if (!res[0].catalog) {
							return;
						}
						this.$data.file = res[0];
						this.$data.storages[res[0].filename] = res[0];
						location.hash = "";
						localStorage.setItem("TxtReader", JSON.stringify(this.$data.storages));
						// console.log(this.$data.file);
					})
				},
			},
			watch: {
				"file.chapter": function (newValue, oldValue) {
					if (newValue) {
						document.body.scrollTop = document.documentElement.scrollTop = 0;
						localStorage.setItem("TxtReader", JSON.stringify(this.$data.storages));
					}
				},
			}
		})

		function getCatalog(text) {
			const reg = /^第(.*)章/;
			// const reg_g = /第(.*?)章(.*?)\r/g;
			const reg_g = /第(.*)章(.*)/g;
			return text.match(reg_g);
		}
		function generatorCatalog(catalog) {
			return catalog.reduce((total, value, index) => {
				total += '<a href="#' + index + '"><div class="col-md-3 col-sm-6 col-xs-12">' + value + '</div></a>';
				return total;
			}, '')
		}
		$(document).ready(function () {
			let file = {};
			var inputElement = document.getElementById("files");
			var tableElement = document.getElementById("table");
			$(document).on("change", "input[type=file]", function (e) {
				// handleFiles($(e.target)[0].files);
			})

			// 读取文件内容
			function handleFiles(files) {
				let promiseArray = [];
				for (let key in files) {
					if (!["length", "item"].includes(key)) {
						promiseArray.push(new Promise((resolve, reject) => {
							const file = files[key];
							const file_split = file.name.split(".");
							var reader = new FileReader();//这里是核心！！！读取操作就是由它完成的。
							reader.readAsText(file, 'UTF-8');//读取文件的内容
							reader.onload = function () {
								//当读取完成之后会回调这个函数，然后此时文件的内容存储到了result中。直接操作即可。
								resolve(Object.assign({
									name: file.name,
									lastModified: file.lastModified,
									lastModifiedDate: file.lastModifiedDate,
									size: file.size,
									type: file.type,
									webkitRelativePath: file.webkitRelativePath
								}, {
									text: this.result,
									filetype: file_split[file_split.length - 1],
									filename: file_split.length > 2 ? file_split.slice(0, file_split.length - 2).join(".") : null,
									i18n: file_split[file_split.length - 2],
									catalog: getCatalog(this.result) || [],
								}));
							}
						}))
					}
				}


				Promise.all(promiseArray).then(res => {
					file = res[0];
					console.log(file);
					// console.log(file.catalog);
					location.hash = "";
					$("#catalog").html(generatorCatalog(file.catalog));
					// let result = res.map(value => {
					//     if (value.filetype == "json") {
					//         value.content = JSON.parse(value.text);
					//     } else if (value.filetype == "resx") {
					//         const reg = /\<data name=\"(.+?)\" xml\:space=\"preserve\"\>\s+\<value\>(.+?)\<\/value\>/;
					//         const reg_g = /\<data name=\"(.+?)\" xml\:space=\"preserve\"\>\s+\<value\>(.+?)\<\/value\>/g;
					//         value.content = value.text.match(reg_g).reduce((total, value) => {
					//             total[value.match(reg)[1]] = value.match(reg)[2]
					//             return total;
					//         }, {});
					//     }
					//     return value;
					// })
					// result = buildContent(result);
					// buildTable(result);
				})
			}


			window.addEventListener("hashchange", function () {
				if (location.hash != "") {
					// getContent();
				}
			});
			function getContent() {
				document.body.scrollTop = document.documentElement.scrollTop = 0;
				var href = window.location.href;
				var idx = href.indexOf('#');
				const index = parseInt(href.substring(idx + 1));
				let content = file.text.substring(file.text.indexOf(file.catalog[index]), file.text.indexOf(file.catalog[index + 1]));
				content = content.replace(/\n/g, '<br/>');
				content += `
                <p style="text-align:center;">
                <a href="#${index - 1}" style="float:left">上一章</a>
                <a href="#">目录</a>
                <a href="#${index + 1}" style="float:right">下一章</a>
                </p>
                `;
				$("#content").html(content);
				$("#catalog").hide();
			}
			$(document).on("change", "#fontFamily", function (e) {
				// console.log($(e.target).val());
				// var head=document.getElementsByTagName('head')[0];　　　　　//获取到head元素　
				// var link=document.createElement('link');　　　　　　　　　　　　 //创建link元素节点，也就是link标签
				// link.rel="stylesheet";　　　　　　　　　　　　　　　　　　　　//为link标签添加rel属性
				// link.href="basic.css";　　　　　　　　　　　　　　　　　　　　//为link标签添加href属性 ， 属性值是css外链样式表的路径
				// head.appendChild(link);
			})

			/*
			$(document).on("click","#catalog",function(e){
					console.log(e);
					console.log($(e.target).val());
					console.log($(e.target).html());
					console.log($(e.target).text());
					const title=$(e.target).text();
					const index=file.catalog.indexOf(title);
					console.log(file.text.indexOf(title));
					const content=file.text.substring(file.text.indexOf(file.catalog[index]),file.text.indexOf(file.catalog[index+1]));
					console.log(content);
					$("#content").html(content.replace(/\r/g,'<br/>'));
			})
			*/
		})
	</script>
</body>

</html>
